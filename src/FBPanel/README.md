# FBPanel 使用说明

## 1. 自定义指令

FBPanel通过`自定义指令`的形式, 将特定的`操作`和`数据`转换为`bytes`, 并发送到串口服务器。

`自定义指令`在FBPanel的各个分页之间是独立管理的, 相互之间不会影响。

`自定义指令`分为4个部分, 分别是`名称`,`指令`,`变量`,`绑定`。

+ 注: 由于底层实现时使用了`$$`,`@@`作为标记字符, 所以在`自定义指令`中不能出现这些内容。此外, `;`作为元素分隔符也不允许随意使用。

### 1.1 名称

`自定义指令`在同一个Panel分页中必须有唯一的名称, 用于标识这条`自定义指令`的意义, 并作为其它`自定义指令`递归调用这条`自定义指令`的接口。

### 1.2 指令

`指令`负责指出`自定义指令`将`操作`和`数据`转换为`bytes`的逻辑。`指令`分为3种: `调用自定义指令`,`调用函数`,`转义符`, 他们的标识分别为`#`,`!`,`%`。

`指令`可以由多个小`指令`组成, 相互之间使用`;`分隔。例如现有3条指令`[指令1]`,`[指令2]`和`[指令3]`, 则可以使用`[指令1];[指令2];[指令3]`的方式按顺序拼接这些指令。

#### 1.2.1 调用自定义指令

`调用自定义指令`的标识为`#`。`指令`可以通过指定其它`自定义指令`的`名称`来递归调用相应的`自定义指令`。设希望调用的`自定义指令`的名称为`[名称]`, 则调用这条`自定义指令`所需的`指令`为`#[名称]`。

#### 1.2.2 调用函数

`调用函数`的标识为`!`。所需调用的函数必须定义在`./FBFunc/__init__.py`内。设需要调用的函数名为`[函数]`, 所需`变量`的个数为`[n]`, 则调用的格式为`![函数]([n])`(即使`n=0`也不可省略)。

+ 暂不支持函数嵌套调用。

预定义的函数有:

##### 1. `as_bytes(x: Union[bytes, str, int]) -> bytes`

将传入的`x`按`bytes`的方式处理。按所传入`变量`的类型分为3种情况:

1. `bytes`: 直接返回未处理的`x`
2. `str`: 如果`x`以`"0x"`开头, 则按**十六进制**理解所传入的字符串`x`, 否则转换成`int`型后按`int`型处理
3. `int`: **从高位到低位**将`x`转换为`bytes`（与`int`的真实存储顺序相反)

##### 2. `as_str(s) -> bytes`

将传入的`s`转换成`str`并以`ascii`进行编码

##### 3. `as_float(x, bits: int = 4, check: bool = True) -> bytes`

将传入的`x`转换成`float`, 通过`bits`指定目标字节数(`float`为`4`,`double`为`8`), 通过`check`指定是否额外添加字节, 内容为前`bits`个字节的内容求和并对256取模的结果。


#### 1.2.3 转义符

`转义符`的标识为`%`, 本质上是提供简单的方法使用`调用函数`的逻辑来处理`变量`。`转义符`分为以下4类:

1. `%b`: 等价于调用`as_bytes`
2. `%s`: 等价于调用`as_str`
3. `%f`: 等价于调用`as_float`, 指定`bits`为`4`
3. `%lf`: 等价于调用`as_float`, 指定`bits`为`8`

多个`转义符`之间可以省略分隔符`;`, 例如`%b%f%f;%f`是一个合法的`指令`。

### 1.3 变量

`变量`可以作为`数据`传入`指令`中。`变量`有3种类型, 分别是`控件数据`,`按键状态`,`字面值`。

多个`变量`之间用分隔符`;`隔开, 例如`entry1.text;<a>.pressed;(1234)`。`变量`的数量必须与`指令`所需变量数相匹配。

#### 1.3.1 控件数据

使用`控件数据`作为变量时, 设所需使用的`控件`名称为`[控件]`, 属性为`[属性]`, 则使用格式为`[控件].[属性]`。一般文本框形式的控件属性为`text`。例如`entry1.text`

#### 1.3.2 按键状态

`按键状态`与`控件属性`的使用方法类似, 目前只支持`a`~`z`以及`space`键。按键有两种属性, 分别是`pressed`和`released`, 类型为`int`, 取值为`0`或`1`。设所按按键为`[按键]`, 则使用格式为`<[按键]>.pressed`或`<[按键]>.released`。例如`<a>.pressed`, `<space>.released`。

#### 1.3.3 字面值

`字面值`以`(`开头, `)`结尾, 中间的内容将会使用python自带的`eval()`函数进行解释, 例如`(1)`, `(0xff01)`, `("00FF807F")`等。需要注意的是中间不能出现`;`,`$$`,`@@`这些被保留的字符。

### 1.4 绑定

`绑定`指的是触发这条`自定义指令`的条件, 例如点击按钮, 按下按键等。绑定可以分为`按键触发`和`控件触发`两种。与`变量`中相同, `按键触发`只支持`a`~`z`以及`space`键, 并用`<>`标识。按键具有两种固定的绑定: `press`和`release`, 即`<[按键]>.press`或`<[按键]>.release`。`控件触发`的方式则是`[控件名].[属性]`, 如`button.click`,`entry.enter`,`scale.change`等, 由对应的控件定义。

一个特殊的触发语法为`[触发源].period([重复周期])`, 用于周期性触发这条`自定义指令`。所有的`按键`和一部分`控件`支持这种方式: `按键`被按下时会周期触发, `控件`则视功能而定, 例如开关打开等。`重复周期`的单位是ms。

一条`自定义指令`可以没有`绑定`, 意味着只能通过其它`自定义指令`通过`调用自定义指令`的方式来触发这条`自定义指令`。

可以给一条`自定义指令`指定多个`绑定`, 之间用分隔符`;`分开, 例如`button1.click;<a>.press;<b>.period(100);entry1.enter`。
